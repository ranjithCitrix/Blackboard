!function(e,t){for(var r in t)e[r]=t[r]}(this,function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t),r.d(t,"searchByRequestInternal",(function(){return U})),r.d(t,"searchByRequest",(function(){return N})),r.d(t,"debug",(function(){return J}));const n=library.load("buffer").Buffer;function o(e=u(),t=a){return r=>i(e,t)(r).then(e=>e.json())}function i(e=u(),t=a){return async r=>t(r)?Promise.resolve(r):async function(e,t){let r;"function"==typeof e?r=await e(t):(console.error(`Response error = ${await t.text()}, status=${t.status}: ${t.statusText}`),r=e);return r instanceof Error?Promise.reject(r):Promise.reject(new Error(r))}(e,r)}function a(e){return e.ok}function u(e="Response status"){return t=>new Error(`${e}: ${t.status} ${t.statusText}`)}const s={file:"file",title:"title",path:"path",creator:"creator",uploadDate:"uploadDate",size:"size"},c={itemId:"itemId",contentType:"contentType",mimeType:"mimeType",title:"title",path:"path",creator:"creator",uploadDate:"uploadDate",size:"size",parentId:"parentId",foundIn:"foundIn"},l=(Object.values(s),Object.values(c)),f=["and","options","or","order-by","return","contentType"],d="file",p="folder";function y(e){const{and:t,or:r,equals:n,ftcontains:o}=e;if(Array.isArray(r))return m("OR",r);if(Array.isArray(t))return m("AND",t);if(n){if(n.attr===s.file)return n.value;throw new Error("Unsupported attribute in equals: "+n.attr)}if(o){if(o.attr===s.file||null==o.attr)return o.value;throw new Error("Unsupported attribute in ftcontains: "+o.attr)}throw new Error("Unsupported tokens in query: "+Object.keys(e))}function m(e,t){if(0===t.length)return"";{const r=t.map(y).join(` ${e} `);return 1===t.length?r:`(${r})`}}const h={[s.file]:"filename",[s.title]:"title",[s.path]:"filename",[s.creator]:"createdBy",[s.uploadDate]:"createdDateTime",[s.size]:"size"},b=(Object.values(h),{[c.itemId]:"id",[c.contentType]:"__generated_value__",[c.foundIn]:"__generated_value__",[c.mimeType]:"file.mimeType",[c.title]:"name",[c.path]:"webUrl",[c.creator]:"createdBy.user.displayName",[c.uploadDate]:"createdDateTime",[c.size]:"size",[c.parentId]:"parentReference.id",findKeyForValue:function(e){const t=Object.entries(this).filter(([t,r])=>e===r).map(([e])=>e)[0];if(void 0===t)throw new Error("ResponseAttributesMapping element not found by value = "+e);return t},findValue:function(e){const t=this[e];return"__generated_value__"!==t?t:void 0}}),g=Object.values(b).filter(e=>"__generated_value__"!==e&&"function"!=typeof e),v=library.load("lodash");function w(e){var t;const{attributes:r}=null!==(t=null==e?void 0:e.return)&&void 0!==t?t:{};return null==r||Array.isArray(r)&&0===r.length?g:r.map(e=>b.findValue(e)).filter(e=>!!e)}function _(e){return t=>{try{const n=(r=t.value,Array.isArray(r)?r:[]).map(O),o=function(e){return v.uniq([...w(e),b[c.itemId],b[c.parentId]])}(e);return n.map(e=>({...Object.entries(e).map(([e,t])=>{if(o.includes(e)){return[b.findKeyForValue(e),t]}return[]}).filter(e=>e.length>0).reduce((e,[t,r])=>(e[t]=r,e),{}),contentType:A(e)}))}catch(e){throw new Error(`mapResponseAttributes Error ${e.message} ${e.stack}`)}var r}}function j(e,t){return t?`${t}.${e}`:e}function O(e){return Object.entries(e).reduce((e,[t,r])=>($(r)?function e(t,r,n){return Object.entries(n).forEach(([n,o])=>{$(o)?e(t,j(n,r),o):t[j(n,r)]=o})}(e,t,r):null!=r&&(e[t]=r),e),{})}function $(e){return null!==e&&"object"==typeof e}function T(e,t){return void 0!==t.find(function(e){return t=>t.match(new RegExp(e,"i"))}(e))}function A(e){const t=Object.keys(e);if(T("folder",t))return p;if(T("file",t))return d;{const t=d;return console.warn(`Can't detect contentType for resource id=${e.id}, returning ${t}`),t}}function q(e){const t=[];return null==e||(e.attributes&&!Array.isArray(e.attributes)?t.push({error:"return_attributes_not_array",message:"return.attributes might be omitted or must be an array."}):e.attributes&&(E(e).length>0&&t.push({warning:"return_attributes_not_string",message:"return.attributes elements must be strings but found "+E(e)}),P(e).length>0&&t.push({warning:"return_attributes_unsupported_value",message:"return.attributes contains unsupported values = "+P(e)}))),t}function I(e){const t=[],r=Object.keys(e).filter(e=>!f.includes(e));return r.length>0&&t.push({warning:"query_contains_unsupported_element",message:'"query" property contains unsupported elements: '+r}),t}function E(e){return e.attributes.map(e=>typeof e).filter(e=>"string"!==e)}function P(e){return e.attributes.map(e=>({type:typeof e,element:e})).filter(e=>"string"===e.type&&!l.includes(e.element)).map(({element:e})=>e)}class S{static encode(e){return function(e){return n.from(e,"utf8").toString("base64")}(e)}static convertHeaders(e){return Array.isArray(e)?e:Object.entries(e).map(([e,t])=>({name:e,value:t}))}constructor(...e){let t,r,n;"object"==typeof e[0]?({statusCode:t,headers:r,body:n}=e[0]):[t,r,n]=e,this.statusCode=t||200,this.headers=S.convertHeaders(r||{}),this.body=S.encode(n||"")}}function R(e){return 401===e.status?e.text().then(x).then(e=>{throw e}):e}function x(e){return new S({statusCode:401,body:e})}function k(e){return e instanceof S?e:new S({body:e,statusCode:200})}function C(e,t=500){if(e instanceof S)return e;let r;return"string"==typeof e?r=e:e instanceof Error&&(r=e.message,e.stack&&(r=`${r}\n${e.stack}`)),new S(t,void 0,r)}const D=library.load("lodash"),z="https://graph.microsoft.com/v1.0";async function U({client:e,parameters:t}){const r=(i=t.requestBody,n.from(i,"base64").toString("utf8"));var i;const a=JSON.parse(r),u=[...I((s=a).query),...q(s.return)];var s,c;if(u.filter(e=>!!e.error).length>0)return c={error:{message:"Request contains validation errors. Unable to continue.",errors:u.filter(e=>!!e.error),warning:u.filter(e=>!!e.warning)}},new S({statusCode:400,body:c});u.filter(e=>!!e.warning).length>0&&u.filter(e=>!!e.warning).forEach(({warning:e,message:t})=>{console.warn(`Request validation contains warning: code=${e}, message=${t}`)});const l=y(a.query),f=`${z}/me/drive/search(q='${l}')`;return e.fetch(f).then(R).then(o(`Graph request to '${f}' failed`)).then(_(a)).then(function(e,t){return e=>{const r=D.uniq(e.map(({parentId:e})=>e)).filter(e=>!!e||(console.warn("postProcessAttributes - checking parentIds and found empty id, probably 'parentId' attribute mapping error?"),!1)).map(e=>({url:"/me/drive/items/"+e,method:"GET",id:e})),n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requests:r})};return t.fetch("https://graph.microsoft.com/v1.0/$batch",n).then(o("Can't fetch drive items for resolving folder names")).then(({responses:e})=>e.map(({id:e,body:{webUrl:t}})=>({id:e,webUrl:t})).reduce((e,{id:t,webUrl:r})=>(e[t]=r,e),{})).then(t=>e.map(e=>{const r=t[e.parentId];if(r){const t=r.match(/^([^:]+:\/\/)(.*)$/),n=Array.isArray(t)&&3===t.length?t[2]:r;return{...e,foundIn:n}}return e}))}}(0,e)).then(e=>({results:e})).then(JSON.stringify)}const N=(B=U,(...e)=>{try{const t=B(...e);return t instanceof S?t:t instanceof Promise?t.then(k).catch(C):Promise.resolve(k(t))}catch(e){return console.error("Caught unexpected error in withHttpResponse wrapper: "+e.message),Promise.resolve(C(e))}});var B;function J({parameters:e}){return console.log("Got parameters",JSON.stringify(e)),JSON.stringify(e)}}]));